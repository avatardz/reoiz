/*
 copyright (c) 2018 humbletim all rights reserved 
*/
var VERSION="0.0.0e",config={icon:_icon("#ddd","#000"),activeIcon:_icon("#ff0","#000"),text:"FACELIGHTZ"},tablet=Tablet.getTablet("com.highfidelity.interface.tablet.system"),button=tablet.addButton(config),base=Script.resolvePath("").replace(".min.js",".js")+"#"+VERSION,url=base.replace(".js",".html"),DEFAULT_JSON=Script.require(base.replace(".js",".json")),schema={title:"Face Light Entity "+VERSION,type:"object",id:"facelight",properties:{isSpotlight:{type:"boolean",format:"checkbox"},parentJointName:{type:"string",
"enum":"Head HeadTop_End Neck Spine2 Hips _CONTROLLER_LEFTHAND _CONTROLLER_RIGHTHAND".split(" ")},color:{type:"string",format:"color",headerTemplate:"self"},pitch:{type:"number",format:"range",headerTemplate:"self / 100",minimum:-18E3,maximum:18E3},offsetY:{type:"number",format:"range",headerTemplate:"self / 100",minimum:-200,maximum:200},offsetZ:{type:"number",format:"range",headerTemplate:"self / 100",minimum:-200,maximum:200},size:{type:"number",format:"range",headerTemplate:"self / 100",minimum:0.1,
maximum:200},intensity:{type:"integer",format:"range",headerTemplate:"self / 100",minimum:-1E5,maximum:1E5},falloffRadius:{type:"number",format:"range",headerTemplate:"self / 100",minimum:0,maximum:400},cutoff:{type:"integer",format:"range",headerTemplate:"self / 100",minimum:-1E3,maximum:5E3},exponent:{type:"number",format:"range",headerTemplate:"self / 100",minimum:-1,maximum:1E4}}},i=0,p;for(p in schema.properties)schema.properties[p].propertyOrder=i++;button.clicked.connect(onClicked);tablet.screenChanged.connect(onScreenChanged);
tablet.webEventReceived.connect(onWebEventReceived);Script.scriptEnding.connect(cleanup);
var state=Object.defineProperties({_screen:{},_update:function(){if(state.screenShown&&state.light&&state.light.visible){var a=MyAvatar.getAbsoluteJointRotationInObjectFrame(getLightJointIndex()),b=MyAvatar.getAbsoluteJointTranslationInObjectFrame(getLightJointIndex());DebugDraw.addMarker(config.text,Quat.multiply(Quat.multiply(MyAvatar.orientation,Quat.multiply(a,state.light.localRotation)),Quat.fromPitchYawRollDegrees(180,0,0)),Vec3.sum(b,Vec3.sum(MyAvatar.position,Vec3.multiplyQbyV(Quat.multiply(MyAvatar.orientation,
a),state.light.localPosition))),{})}else DebugDraw.removeMarker(config.text)},_updateThread:new function(){var a=Script.setInterval(function(){state._update()},1E6);a.stop();a.interval=1E3/30;return a}},{light:{get:function(){return getFaceLights()[0]}},json:{get:function(){return Settings.getValue("torchfacelight/json")||DEFAULT_JSON},set:function(a){Settings.setValue("torchfacelight/json",a)}},shifted:{get:function(){return Controller.getValue(Controller.Hardware.Keyboard.Shift)}},screen:{set:function(a){this._screen=
a;a=this.screenShown;button.editProperties({text:a?"["+config.text+"]":config.text});a?state._updateThread.start():(DebugDraw.removeMarker(config.text),state._updateThread.stop());return this._screen},get:function(){return this._screen}},active:{set:function(a){updateFaceLight({visible:a});button.editProperties({isActive:a})},get:function(){return button.getProperties().isActive}},screenShown:{set:function(a){var b=this.screenShown;console.info("screenShown",b,a);b&&!a?tablet.gotoHomeScreen():!b&&
a&&tablet.gotoWebScreen(url);return a},get:function(){return this._screen&&"Web"===this._screen.type&&this._screen.url===url}}});function getLightJointIndex(a){"string"===typeof a&&(a=MyAvatar.getJointIndex(a));state.light&&(a=state.light.parentJointIndex);return isNaN(a)||-1===a||65535===a?MyAvatar.getJointIndex("Head"):a}
function getFaceLights(){return Object.keys(MyAvatar.getAvatarEntityData()).filter(function(a){return"entity"===Entities.getNestableType(a)}).map(function(a){return Entities.getEntityProperties(a)}).filter(function(a){return a.name===config.text})}
function updateFaceLight(a){var b=state.json,d=!1,c;for(c in a)b[c]=a[c],d=!0;d&&("parentJointName"in a&&(c=MyAvatar.getJointIndex(a.parentJointName),-1!==c&&65535!==c&&(a.parentJointIndex=b.parentJointIndex=c,print("parentJointIndex",b.parentJointName,b.parentJointIndex))),d&&"parentJointIndex"in a&&(a.localPosition=b.localPosition,a.localRotation=b.localRotation));c=state.light&&state.light.id;!c&&"visible"in b&&(b.parentID=MyAvatar.sessionUUID,b.parentJointIndex=getLightJointIndex(b.parentJointName||
b.parentJointIndex),b.name=config.text,print("creating face light",JSON.stringify({index:b.parentJointIndex,name:b.parentJointName})),c=Entities.addEntity(b,!0));d&&(print("updating face light",JSON.stringify(a)),b.visible?Entities.editEntity(c,a):Entities.deleteEntity(c),state.json=b,state._update());return state.light}function onClicked(){print("onClicked");state.shifted?state.screenShown=!state.screenShown:(state.active=!state.active,print("state.active",state.active))}
function onScreenChanged(a,b){state.screen={type:a,url:b}}function hexToRGB(a){return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{red:parseInt(a[1],16),green:parseInt(a[2],16),blue:parseInt(a[3],16)}:null}
function onWebEventReceived(a){try{var b=JSON.parse(a)}catch(d){return}print("onWebEventReceived",a,b);if("change"===b.type){var c=state.light||{};a=b.property;b=b.value;"number"===typeof b&&(b/=100);var e={};print(a,b);"color"===a?print(a,JSON.stringify(b=hexToRGB(b))):"parentJointName"!==a&&("pitch"===a?(a="localRotation",b=Quat.fromPitchYawRollDegrees(b,0,0)):"offsetY"===a?(a="localPosition",c=c.localPosition||Vec3.ZERO,c.y=b,b=c):"offsetZ"===a?(a="localPosition",c=c.localPosition||Vec3.ZERO,c.z=
b,b=c):"size"===a&&(a="dimensions",b=Vec3.multiply(b,Vec3.ONE)));e[a]=b;updateFaceLight(e)}else"onload"===b.type&&(state.active=!0,c=updateFaceLight({}),a={isSpotlight:c.isSpotlight,parentJointName:MyAvatar.jointNames[getLightJointIndex()]||state.json.parentJointName,color:"#"+[c.color.red,c.color.green,c.color.blue].map(function(a){return("0"+a.toString(16)).substr(-2)}).join(""),intensity:100*c.intensity,cutoff:100*c.cutoff,falloffRadius:100*c.falloffRadius,exponent:100*c.exponent,pitch:100*Quat.safeEulerAngles(c.localRotation).x,
offsetY:100*c.localPosition.y,offsetZ:100*c.localPosition.z,size:100*c.dimensions.x},tablet.emitScriptEvent(JSON.stringify({type:"schema",schema:schema,defaults:a})))}var skeletonModelURL=MyAvatar.skeletonModelURL;function onSkeletonChanged(){var a=state.json;a.parentJointName&&Script.setTimeout(function(){updateFaceLight({parentJointName:a.parentJointName})},100)}MyAvatar.skeletonChanged.connect(onSkeletonChanged);
function cleanup(){DebugDraw.removeMarker(config.text);try{tablet.removeButton(button)}catch(a){}state.screenShown=!1;state.active=!1;button.clicked.disconnect(onClicked);tablet.screenChanged.disconnect(onScreenChanged);MyAvatar.skeletonChanged.disconnect(onSkeletonChanged);getFaceLights().forEach(function(a){return Entities.deleteEntity(a.id)})}
function _icon(a,b){return'data:image/svg+xml;xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 784.77 784.77"><path d="M784.77 392.39c0 216.71-175.68 392.38-392.38 392.38C175.68 784.77.01 609.09.01 392.39.01 175.68 175.69.01 392.39.01c216.71 0 392.38 175.68 392.38 392.38z" fill="black" /><path d="M392.25 96.53c-1.484.003-161.79.681-161.79 169.35 0 108.58 73.691 148.83 68.547 158.26l16.129 57.206h3.528c-12.54 0-22.68 10.14-22.68 22.681s10.14 22.681 22.68 22.681h26.21l-34.778 13.357c-11.705 4.503-17.607 17.78-13.104 29.485 4.503 11.705 17.528 17.355 29.233 12.852l140.12-53.93c1.39-.535 2.564-1.257 3.78-2.016.081-.005.173.007.252 0 11.73-.875 20.917-10.468 20.917-22.43 0-12.196-9.61-22.144-21.673-22.68l16.129-57.206c-5.145-9.432 68.547-49.678 68.547-158.26 0-168.67-160.31-169.35-161.79-169.35zm-57.962 39.314v.504c8.212-2.034 12.015 11.339 1.335 14.497-32.117 9.08-51.233 49.766-51.233 49.766-6.582 11.424-18.952 3.56-14.259-4.6 5.495-14.897 29.11-51.857 64.157-60.166zm124.74 405.99a22.39 22.39 0 0 0-8.82 1.512l-140.12 53.93c-11.705 4.503-17.607 17.528-13.104 29.233 1.688 4.39 4.746 7.836 8.316 10.332 1.903 2.332 4.09 4.426 6.804 6.048l66.53 39.566c4.52 3.702 10.121 5.827 15.877 5.796 5.614.086 11.136-1.818 15.625-5.292l67.034-40.07c12.358-7.384 16.59-23.465 9.577-36.037s-22.672-16.709-35.03-9.324l-57.205 34.02-18.65-11.087 90.473-34.777c11.705-4.503 17.607-17.528 13.104-29.233-3.377-8.779-11.594-14.337-20.413-14.617z" fill="white"/></svg>'.replace("white",a||
"white").replace("black",b||"black")};
